// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// 组织架构：部门
model Department {
  id        Int          @id @default(autoincrement())
  name      String       @unique
  users     User[] // 一个部门有多个用户
  parentId  Int? // 用于实现父子部门树
  parent    Department?  @relation("DeptToDept", fields: [parentId], references: [id])
  children  Department[] @relation("DeptToDept")
  createdAt DateTime     @default(now()) @db.Timestamptz
  updatedAt DateTime     @updatedAt @db.Timestamptz
}

// 用户模型
model User {
  id           Int         @id @default(autoincrement())
  username     String      @unique
  password     String
  realName     String?
  email        String?     @unique
  departmentId Int?
  department   Department? @relation(fields: [departmentId], references: [id])
  roles        Role[]      @relation("UserRoles") // 多对多关联角色

  // 个人信息
  avatar      String  @default("/avatar.jpg") // 头像地址
  phone       String? // 手机号码
  wechatOpenId String? // 微信公众号OpenID

  // 单点登录相关字段
  tokenVersion Int       @default(0) // Token版本号，用于实现单点登录（登录时递增，使旧token失效）
  lastLoginAt  DateTime? @db.Timestamptz // 最后登录时间
  lastLoginIp  String? // 最后登录IP

  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz
}

// RBAC：角色
model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique // 如: admin, manager, employee
  description String?
  users       User[]       @relation("UserRoles")
  permissions Permission[] @relation("RolePermissions")
  createdAt   DateTime     @default(now()) @db.Timestamptz
  updatedAt   DateTime     @updatedAt @db.Timestamptz
}

// RBAC：权限点
model Permission {
  id        Int      @id @default(autoincrement())
  name      String   @unique // 如: 用户管理
  code      String   @unique // 如: user:list, user:create
  roles     Role[]   @relation("RolePermissions")
  createdAt DateTime @default(now()) @db.Timestamptz
  updatedAt DateTime @updatedAt @db.Timestamptz
}

// 系统配置（键值对形式存储）
model SiteConfig {
  id          Int      @id @default(autoincrement())
  key         String   @unique // 配置键，如: site_title, site_logo
  value       String   @db.Text // 配置值
  description String? // 配置说明
  group       String   @default("general") // 配置分组，如: general, appearance, seo
  createdAt   DateTime @default(now()) @db.Timestamptz
  updatedAt   DateTime @updatedAt @db.Timestamptz
}
